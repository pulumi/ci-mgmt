permissions: write-all
name: Deploy pulumi-provider-repos stack
on:
  merge_group: {}
  workflow_dispatch: {}

env:
  ESC_ACTION_OIDC_AUTH: true
  ESC_ACTION_OIDC_ORGANIZATION: pulumi
  ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
  ESC_ACTION_ENVIRONMENT: github-secrets/pulumi-ci-mgmt

concurrency:
  group: pulumi-provider-repos
  cancel-in-progress: false # Don't cancel in-progress deployments

jobs:
  deploy:
    name: Deploy provider repository settings
    runs-on: ubuntu-latest
    steps:
      - name: Fetch secrets from ESC
        id: esc-secrets
        uses: pulumi/esc-action@6cf9520e68354d86f81c455e8d43eabd58f5c9f5 # v1

      - name: Checkout Repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Install mise
        uses: jdx/mise-action@c1a019b8d2586943b4dbebc456323b516910e310
        with:
          version: 2026.2.10

      - name: Install dependencies
        working-directory: infra/providers
        run: npm ci

      - name: Pulumi login
        run: pulumi login https://api.pulumi.com
        env:
          PULUMI_ACCESS_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_ACCESS_TOKEN }}

      - name: Select stack
        working-directory: infra/providers
        run: pulumi stack select pulumi/pulumi-provider-repos/production

      - name: Pulumi up
        working-directory: infra/providers
        run: pulumi up --yes --skip-preview
        env:
          PULUMI_ACCESS_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_ACCESS_TOKEN }}
