permissions: write-all
name: Linear Agent Worker

on:
  workflow_dispatch:
    inputs:
      repo:
        required: true
        type: string
        description: "Short provider name, e.g. 'aws' for pulumi-aws"
      linear_session_id:
        required: true
        type: string
        description: "Linear AgentSession ID"
      issue_title:
        required: true
        type: string
        description: "Linear issue title"
      issue_body:
        required: true
        type: string
        description: "Linear issue body / description"
      event_type:
        required: false
        type: string
        default: created
        description: "'created' for new issue assignment, 'prompted' for follow-up comment"
      prompt_body:
        required: false
        type: string
        default: ""
        description: "Body of the follow-up comment (populated when event_type=prompted)"

env:
  ESC_ACTION_OIDC_AUTH: true
  ESC_ACTION_OIDC_ORGANIZATION: pulumi
  ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
  ESC_ACTION_ENVIRONMENT: github-secrets/pulumi-ci-mgmt

jobs:
  process-repo:
    name: Process pulumi-${{ inputs.repo }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Fetch secrets from ESC
        id: esc-secrets
        uses: pulumi/esc-action@6cf9520e68354d86f81c455e8d43eabd58f5c9f5 # v1

      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-auth
        with:
          app-id: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_APP_ID }}
          private-key: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_PRIVATE_KEY }}
          owner: pulumi

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Run Claude Worker Agent
        id: claude-agent
        uses: anthropics/claude-code-action@8341a564b0c1693e9fa29c681852ee3714980098 # v1
        with:
          anthropic_api_key: ${{ steps.esc-secrets.outputs.ANTHROPIC_API_KEY }}
          # Sandbox settings: Edit() rules control all bash filesystem writes (mkdir,
          # output redirection, etc.), not just the Edit tool.
          settings: |
            {
              "permissions": {
                "allow": ["Edit(./**)", "Edit(/tmp/**)"]
              }
            }
          claude_args: |
            --max-turns 50
            --allowedTools "Skill,Read,Write,Edit,MultiEdit,Glob,Grep,LS,Bash(gh *),Bash(git *),Bash(make *),Bash(curl *),Bash(mkdir *),Bash(ls *),Bash(cat *)"
          prompt: |
            You are a CI automation worker processing one provider repository.

            REPO:              ${{ inputs.repo }}
            LINEAR SESSION ID: ${{ inputs.linear_session_id }}
            EVENT TYPE:        ${{ inputs.event_type }}
            ISSUE TITLE:       ${{ inputs.issue_title }}

            ISSUE BODY:
            ${{ inputs.issue_body }}

            ${{ inputs.prompt_body != '' && format('FOLLOW-UP / REFINEMENT (takes precedence for this repo):\n{0}', inputs.prompt_body) || '' }}

            ## Instructions

            1. Post a `thought` activity to Linear at the start. Use the LINEAR_API_KEY
               environment variable (already set). Example:
               ```
               curl -s -X POST https://api.linear.app/graphql \
                 -H "Authorization: $LINEAR_API_KEY" \
                 -H "Content-Type: application/json" \
                 -d '{"query":"mutation { agentActivityCreate(input: {sessionId:\"${{ inputs.linear_session_id }}\",type:thought,body:\"Starting work on pulumi-${{ inputs.repo }}...\"}) { success } }"}'
               ```

            2. Check `.claude/skills/` for a skill that matches the task described in the
               issue. If a matching skill exists, use it to guide your approach. If no
               matching skill exists, use the issue title and body directly.

            3. If a FOLLOW-UP / REFINEMENT section is present above, treat it as a
               refinement or override that takes precedence over the general issue
               instructions for this specific repo.

            4. Clone the provider repository:
               ```
               gh repo clone pulumi/pulumi-${{ inputs.repo }} /tmp/pulumi-${{ inputs.repo }}
               ```

            5. Make the necessary changes in /tmp/pulumi-${{ inputs.repo }} as described
               by the issue (and refined by the follow-up if provided). Commit the changes.

            6. Create a pull request:
               ```
               gh pr create \
                 --repo pulumi/pulumi-${{ inputs.repo }} \
                 --title "..." \
                 --body "Automated by Linear issue: ${{ inputs.issue_title }}"
               ```

            7. Post an `action` activity to Linear with the PR URL:
               ```
               curl -s -X POST https://api.linear.app/graphql \
                 -H "Authorization: $LINEAR_API_KEY" \
                 -H "Content-Type: application/json" \
                 -d '{"query":"mutation { agentActivityCreate(input: {sessionId:\"${{ inputs.linear_session_id }}\",type:action,body:\"Created PR pulumi/pulumi-${{ inputs.repo }}#NUMBER: URL\"}) { success } }"}'
               ```
               Replace NUMBER and URL with the actual PR number and URL from step 6.

            If any step fails, post an `action` activity to Linear describing the failure:
            ```
            curl -s -X POST https://api.linear.app/graphql \
              -H "Authorization: $LINEAR_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{"query":"mutation { agentActivityCreate(input: {sessionId:\"${{ inputs.linear_session_id }}\",type:action,body:\"Failed to process pulumi-${{ inputs.repo }}: REASON\"}) { success } }"}'
            ```
            Replace REASON with a concise description of what went wrong.

            ## Available Environment Variables
            - `LINEAR_API_KEY`: for posting activity updates to the Linear session
            - `GH_TOKEN`: for GitHub operations (gh CLI uses this automatically)

            Always post a `thought` at the start and an `action` (success or failure) at the end.
        env:
          LINEAR_API_KEY: ${{ steps.esc-secrets.outputs.LINEAR_API_KEY }}
          GH_TOKEN: ${{ steps.app-auth.outputs.token }}

      - name: Upload execution log on failure
        if: failure() && steps.claude-agent.outputs.execution_file
        uses: actions/upload-artifact@v4
        with:
          name: claude-linear-worker-${{ inputs.repo }}-log
          path: ${{ steps.claude-agent.outputs.execution_file }}
          retention-days: 7
