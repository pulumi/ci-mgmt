# Linear GraphQL schema reference:
#   https://studio.apollographql.com/public/Linear-API/variant/current/schema/reference
# All Linear GraphQL queries in this file should be double-checked against that schema.

permissions: write-all
name: Linear Agent Worker

on:
  workflow_dispatch:
    inputs:
      repo:
        required: true
        type: string
        description: "Short provider name, e.g. 'aws' for pulumi-aws"
      linear_session_id:
        required: true
        type: string
        description: "Linear AgentSession ID"
      linear_issue_id:
        required: true
        type: string
        description: "Linear issue UUID (used to look up the human-readable identifier for branch naming)"
      issue_title:
        required: true
        type: string
        description: "Linear issue title"
      event_type:
        required: false
        type: string
        default: created
        description: "'created' for new issue assignment, 'prompted' for follow-up comment"
      prompt_body:
        required: false
        type: string
        default: ""
        description: "Body of the follow-up comment (populated when event_type=prompted)"

env:
  ESC_ACTION_OIDC_AUTH: true
  ESC_ACTION_OIDC_ORGANIZATION: pulumi
  ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
  ESC_ACTION_ENVIRONMENT: github-secrets/pulumi-ci-mgmt

jobs:
  process-repo:
    name: Process pulumi-${{ inputs.repo }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Fetch secrets from ESC
        id: esc-secrets
        uses: pulumi/esc-action@6cf9520e68354d86f81c455e8d43eabd58f5c9f5 # v1

      # - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
      #   id: app-auth
      #   with:
      #     app-id: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_APP_ID }}
      #     private-key: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_PRIVATE_KEY }}
      #     owner: pulumi

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - uses: jdx/mise-action@v2

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          repository: pulumi/pulumi-${{ inputs.repo }}
          path: provider-repo
          token: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}
          fetch-depth: 0

      - name: Configure git user for provider repo
        run: |
          git -C provider-repo config user.email "pulumi-bot@pulumi.com"
          git -C provider-repo config user.name "Pulumi Bot"

      - name: Get claude executable path
        id: claude
        run: echo "claude=$(which claude)" >> "$GITHUB_OUTPUT"

      - name: Run Claude Worker Agent
        id: claude-agent
        uses: anthropics/claude-code-action@8341a564b0c1693e9fa29c681852ee3714980098 # v1
        with:
          path_to_claude_code_executable: ${{ steps.claude.outputs.claude }}
          anthropic_api_key: ${{ steps.esc-secrets.outputs.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}
          allowed_bots: pulumi-provider-automation
          # Sandbox settings: Edit() rules control all bash filesystem writes (mkdir,
          # output redirection, etc.), not just the Edit tool.
          settings: |
            {
              "permissions": {
                "allow": ["Edit(./**)", "Edit(/tmp/**)"]
              }
            }
          claude_args: |
            --max-turns 200
            --allowedTools "Skill,Read,Write,Edit,MultiEdit,Glob,Grep,LS,Bash(gh *),Bash(git *),Bash(make *),Bash(mise *),Bash(curl *),Bash(mkdir *),Bash(ls *),Bash(cat *)"
          prompt: |
            You are a CI automation worker processing one provider repository.

            REPO:              ${{ inputs.repo }}
            LINEAR SESSION ID: ${{ inputs.linear_session_id }}
            EVENT TYPE:        ${{ inputs.event_type }}
            ISSUE TITLE:       ${{ inputs.issue_title }}

            ${{ inputs.prompt_body != '' && format('FOLLOW-UP / REFINEMENT (takes precedence for this repo):\n{0}', inputs.prompt_body) || '' }}

            ## CRITICAL: Repository Location

            The provider repository `pulumi/pulumi-${{ inputs.repo }}` is ALREADY checked
            out at `./provider-repo` (relative to your working directory). Do NOT clone it,
            do NOT use /tmp, do NOT run `git clone`. All git and file operations on the
            provider must use the path `./provider-repo`.

            ## Instructions

            1. Post a `thought` activity to Linear at the start. Use the LINEAR_API_KEY
               environment variable (already set). Example:
               ```
               curl -s -X POST https://api.linear.app/graphql \
                 -H "Authorization: Bearer $LINEAR_API_KEY" \
                 -H "Content-Type: application/json" \
                 -d '{"query":"mutation { agentActivityCreate(input: {agentSessionId:\"${{ inputs.linear_session_id }}\",content:{type:\"thought\",body:\"Starting work on pulumi-${{ inputs.repo }}...\"}}) { success } }"}'
               ```

            2. Fetch the full issue context from Linear. This also retrieves the parent
               issue if this is a sub-issue, so you have complete context:
               ```
               ISSUE_DATA=$(curl -s -X POST https://api.linear.app/graphql \
                 -H "Authorization: Bearer $LINEAR_API_KEY" \
                 -H "Content-Type: application/json" \
                 -d '{"query":"{ issue(id: \"${{ inputs.linear_issue_id }}\") { identifier title description parent { identifier title description } } }"}')
               echo "$ISSUE_DATA"
               ```
               Extract and use the `description` field as the issue body. If `parent` is
               non-null, include the parent's `title` and `description` as additional context
               (the sub-issue refines or specialises the parent task).

            3. Check `.claude/skills/` in your current working directory (the ci-mgmt repo)
               for a skill that matches the task described in the issue. Use the LS tool —
               not bash — to list the directory; it won't error if the directory is missing.
               If a matching skill exists, use it to guide your approach. If no matching
               skill exists, use the issue title and body directly.

            4. If a FOLLOW-UP / REFINEMENT section is present above, treat it as a
               refinement or override that takes precedence over the general issue
               instructions for this specific repo.

            5. Determine the branch name from the `identifier` returned in step 2.
               Lowercase it (e.g. `ENG-123` → `eng-123`).

            6. Check whether a PR already exists on that branch in the provider repo.
               If one exists, check out the existing branch and update it; otherwise
               create a new branch.
               ```bash
               cd ./provider-repo

               BRANCH_NAME="<computed above>"

               # Check for an open PR on this branch
               EXISTING_PR=$(gh pr list \
                 --repo pulumi/pulumi-${{ inputs.repo }} \
                 --state open \
                 --head "$BRANCH_NAME" \
                 --json number,url \
                 --jq '.[0]')

               if [ -n "$EXISTING_PR" ]; then
                 # Fetch and check out the existing branch
                 git fetch origin "$BRANCH_NAME"
                 git checkout "$BRANCH_NAME"
               else
                 git checkout -b "$BRANCH_NAME"
               fi
               ```

            7. Make the necessary changes in `./provider-repo` as described by the issue
               (and refined by the follow-up if provided). Commit the changes and push
               the branch.

               **If you determine that no changes are needed** (e.g. the repository
               already reflects the desired state), skip steps 8–9 and instead:

               a. Find the "completed" workflow state for the issue's team:
                  ```
                  STATES=$(curl -s -X POST https://api.linear.app/graphql \
                    -H "Authorization: Bearer $LINEAR_API_KEY" \
                    -H "Content-Type: application/json" \
                    -d '{"query":"{ issue(id: \"${{ inputs.linear_issue_id }}\") { team { states { nodes { id type } } } } }"}')
                  DONE_STATE_ID=$(echo "$STATES" | jq -r \
                    '.data.issue.team.states.nodes[] | select(.type=="completed") | .id' \
                    | head -1)
                  ```

               b. Mark the issue as done:
                  ```
                  curl -s -X POST https://api.linear.app/graphql \
                    -H "Authorization: Bearer $LINEAR_API_KEY" \
                    -H "Content-Type: application/json" \
                    -d "{\"query\":\"mutation { issueUpdate(id: \\\"${{ inputs.linear_issue_id }}\\\", input: { stateId: \\\"$DONE_STATE_ID\\\" }) { success } }\"}"
                  ```

               c. Post an `action` activity explaining that no changes were needed:
                  ```
                  curl -s -X POST https://api.linear.app/graphql \
                    -H "Authorization: Bearer $LINEAR_API_KEY" \
                    -H "Content-Type: application/json" \
                    -d '{"query":"mutation { agentActivityCreate(input: {agentSessionId:\"${{ inputs.linear_session_id }}\",content:{type:\"action\",body:\"No changes needed for pulumi-${{ inputs.repo }} — already up to date. Marked issue as done.\"}}) { success } }"}'
                  ```
                  Then stop; do not proceed to step 8.

            8. Create or update the pull request:
               - If `$EXISTING_PR` was non-empty (PR already exists): push the branch and
                 update the PR description:
                 ```
                 git push origin "$BRANCH_NAME"
                 PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
                 gh pr edit "$PR_NUMBER" \
                   --repo pulumi/pulumi-${{ inputs.repo }} \
                   --body "Automated by Linear issue: ${{ inputs.issue_title }}"
                 PR_URL=$(echo "$EXISTING_PR" | jq -r '.url')
                 ```
               - If no existing PR: push and create a new one:
                 ```
                 git push origin "$BRANCH_NAME"
                 PR_URL=$(gh pr create \
                   --repo pulumi/pulumi-${{ inputs.repo }} \
                   --head "$BRANCH_NAME" \
                   --title "..." \
                   --body "Automated by Linear issue: ${{ inputs.issue_title }}" \
                   --json url --jq '.url')
                 ```

            9. Post an `action` activity to Linear with the PR URL:
               ```
               curl -s -X POST https://api.linear.app/graphql \
                 -H "Authorization: Bearer $LINEAR_API_KEY" \
                 -H "Content-Type: application/json" \
                 -d '{"query":"mutation { agentActivityCreate(input: {agentSessionId:\"${{ inputs.linear_session_id }}\",content:{type:\"action\",body:\"Created PR pulumi/pulumi-${{ inputs.repo }}#NUMBER: URL\"}}) { success } }"}'
               ```
               Replace NUMBER and URL with the actual PR number and URL from step 8.

            If any step fails, post an `action` activity to Linear describing the failure:
            ```
            curl -s -X POST https://api.linear.app/graphql \
              -H "Authorization: Bearer $LINEAR_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{"query":"mutation { agentActivityCreate(input: {agentSessionId:\"${{ inputs.linear_session_id }}\",content:{type:\"action\",body:\"Failed to process pulumi-${{ inputs.repo }}: REASON\"}}) { success } }"}'
            ```
            Replace REASON with a concise description of what went wrong.

            ## Available Environment Variables
            - `LINEAR_API_KEY`: for posting activity updates to the Linear session
            - `GH_TOKEN`: for GitHub operations (gh CLI uses this automatically)

            Always post a `thought` at the start and an `action` (success or failure) at the end.
        env:
          LINEAR_API_KEY: ${{ steps.esc-secrets.outputs.LINEAR_API_KEY }}
          GH_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}

      - name: Upload execution log on failure
        if: failure() && steps.claude-agent.outputs.execution_file
        uses: actions/upload-artifact@v4
        with:
          name: claude-linear-worker-${{ inputs.repo }}-log
          path: ${{ steps.claude-agent.outputs.execution_file }}
          retention-days: 7
