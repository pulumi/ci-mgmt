# Linear GraphQL schema reference:
#   https://studio.apollographql.com/public/Linear-API/variant/current/schema/reference
# All Linear GraphQL queries in this file should be double-checked against that schema.

permissions: write-all
name: Linear Agent
run-name: "Linear Agent (${{ inputs.linear_issue_id }})"

concurrency:
  group: linear-agent-${{ inputs.linear_session_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      linear_session_id:
        required: true
        type: string
        description: "Linear AgentSession ID"
      linear_issue_id:
        required: true
        type: string
        description: "Linear issue ID"
      event_type:
        required: false
        type: string
        default: created
        description: "'created' for new issue assignment, 'prompted' for follow-up comment"
      prompt_body:
        required: false
        type: string
        default: ""
        description: "Body of the follow-up comment (populated when event_type=prompted)"

env:
  ESC_ACTION_OIDC_AUTH: true
  ESC_ACTION_OIDC_ORGANIZATION: pulumi
  ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
  ESC_ACTION_ENVIRONMENT: github-secrets/pulumi-ci-mgmt

jobs:
  orchestrate:
    name: Orchestrate Linear issue across repos
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: write

    steps:
      - name: Fetch secrets from ESC
        id: esc-secrets
        uses: pulumi/esc-action@6cf9520e68354d86f81c455e8d43eabd58f5c9f5 # v1

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - uses: jdx/mise-action@v2

      - name: Get claude and bun executable paths
        id: claude
        run: |
          echo "claude=$(mise which claude)" >> "$GITHUB_OUTPUT"
          echo "bun=$(mise which bun)" >> "$GITHUB_OUTPUT"

      - name: Cache bun package downloads
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-packages-${{ runner.os }}-8341a564b0c1693e9fa29c681852ee3714980098

      - name: Run Claude Orchestrator
        id: claude-agent
        uses: anthropics/claude-code-action@8341a564b0c1693e9fa29c681852ee3714980098 # v1
        with:
          path_to_claude_code_executable: ${{ steps.claude.outputs.claude }}
          path_to_bun_executable: ${{ steps.claude.outputs.bun }}
          anthropic_api_key: ${{ steps.esc-secrets.outputs.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}
          allowed_bots: pulumi-provider-automation
          claude_args: |
            --max-turns 200
            --allowedTools "Skill,Read,Glob,Grep,LS,Bash(gh workflow run *),Bash(curl *)"
          prompt: |
            You are a CI automation orchestrator triggered by a Linear issue.
            Your job is to parse the issue and dispatch per-repo worker workflows.

            LINEAR SESSION ID: ${{ inputs.linear_session_id }}
            LINEAR ISSUE ID:   ${{ inputs.linear_issue_id }}
            EVENT TYPE:        ${{ inputs.event_type }}

            ${{ inputs.event_type == 'prompted' && format('FOLLOW-UP COMMENT:\n{0}', inputs.prompt_body) || '' }}

            ## Instructions

            1. Post a `thought` activity to Linear at the start. Use the LINEAR_API_KEY
               environment variable (already set). Example:
               ```
               curl -s -X POST https://api.linear.app/graphql \
                 -H "Authorization: Bearer $LINEAR_API_KEY" \
                 -H "Content-Type: application/json" \
                 -d '{"query":"mutation { agentActivityCreate(input: {agentSessionId:\"${{ inputs.linear_session_id }}\",content:{type:\"thought\",body:\"Analyzing issue...\"}}) { success } }"}'
               ```

            2. Fetch the full issue context from Linear. This also retrieves the parent
               issue if this is a sub-issue, so you have complete context:
               ```
               ISSUE_DATA=$(curl -s -X POST https://api.linear.app/graphql \
                 -H "Authorization: Bearer $LINEAR_API_KEY" \
                 -H "Content-Type: application/json" \
                 -d '{"query":"{ issue(id: \"${{ inputs.linear_issue_id }}\") { identifier title description parent { identifier title description } } }"}')
               echo "$ISSUE_DATA"
               ```
               Extract the `title` and `description` fields. If `parent` is non-null,
               include the parent's `title` and `description` as additional context.

            3. Check `.claude/skills/` for any skill that matches the task described in the
               issue.

            4. Determine which repositories to update:
               - **If event_type=created**: First check whether the issue has child
                 (sub) issues in Linear by querying:
                 ```bash
                 curl -s -X POST https://api.linear.app/graphql \
                   -H "Authorization: Bearer $LINEAR_API_KEY" \
                   -H "Content-Type: application/json" \
                   -d '{"query":"{ issue(id: \"${{ inputs.linear_issue_id }}\") { children(first: 250) { nodes { id title description state { name type } } } } }"}'
                 ```
                 **If child issues are returned** (`children.nodes` is non-empty):
                 - Extract the provider short name from each child issue title or
                   description (e.g., "Update pulumi-aws" → "aws"). Skip any child
                   issue that doesn't clearly map to a single provider.
                 - Skip any child issue whose `state.type` is `"completed"` or
                   `"cancelled"` (i.e., already done — do not re-dispatch work for
                   closed sub-issues).
                 - Dispatch one worker per child issue. Pass the **parent** issue title
                   as `issue_title`. The worker will fetch the child issue body and
                   parent context itself.
                 - Because you are dispatching for a sub-issue, pass the **child**
                   issue's `id` as `linear_issue_id` (not the parent's). The worker
                   uses this ID to look up the branch name, so using the parent ID
                   would name the branch after the parent issue.
                 - Do **not** also parse the parent body for additional repos — child
                   issues take precedence.

                 **If no child issues exist** (empty or missing `children.nodes`):
                 - Fall back to parsing the parent issue body to find ALL provider
                   names listed (typically as `pulumi-PROVIDER` or
                   just `PROVIDER`) and dispatch a worker for each one with
                   prompt_body="".

               - **If event_type=prompted**: Read the follow-up comment carefully to
                 identify WHICH specific repos it applies to (could be one, a subset,
                 or all from the original issue). Dispatch workers only for those repos,
                 with prompt_body set to the follow-up comment text. (No need to
                 re-query sub-issues for prompted events.)

            5. For each repo to process, dispatch a worker workflow:
               ```bash
               gh workflow run linear-agent-worker.yml \
                 --repo pulumi/ci-mgmt \
                 --ref blampe/testing \
                 -f repo=PROVIDER_SHORT_NAME \
                 -f linear_session_id="${{ inputs.linear_session_id }}" \
                 -f linear_issue_id=ISSUE_ID \
                 -f issue_title="ISSUE_TITLE" \
                 -f event_type="${{ inputs.event_type }}" \
                 -f prompt_body="PROMPT_BODY"
               ```
               PROVIDER_SHORT_NAME is the short name only, e.g. "aws" for pulumi-aws.
               ISSUE_ID is the child issue id (for sub-issues) or the parent issue id.

               ⚠️ CRITICAL: When dispatching for sub-issues, -f linear_issue_id=ISSUE_ID
               MUST be the child issue's UUID from the API response — NOT the value of
               LINEAR ISSUE ID shown at the top of this prompt (that is the parent issue
               ID and must NOT be forwarded to the worker).

            6. Post a `response` activity to Linear listing the dispatched repos:
               ```
               curl -s -X POST https://api.linear.app/graphql \
                 -H "Authorization: Bearer $LINEAR_API_KEY" \
                 -H "Content-Type: application/json" \
                 -d '{"query":"mutation { agentActivityCreate(input: {agentSessionId:\"${{ inputs.linear_session_id }}\",content:{type:\"response\",body:\"SUMMARY\"}}) { success } }"}'
               ```
               For created events: "Dispatching workers for N repos: provider1, provider2, ..."
               For prompted events: "Dispatching targeted update for REPO based on your comment"

            ## Available Environment Variables
            - `LINEAR_API_KEY`: for posting activity updates to the Linear session
            - `GH_TOKEN`: for dispatching worker workflows via `gh workflow run`

            Always post a `thought` at the start and a `response` at the end, even on failure.
        env:
          LINEAR_API_KEY: ${{ steps.esc-secrets.outputs.LINEAR_API_KEY }}
          GH_TOKEN: ${{ github.token }}

      - name: Upload execution log on failure
        if: failure() && steps.claude-agent.outputs.execution_file
        uses: actions/upload-artifact@v4
        with:
          name: claude-linear-orchestrator-log
          path: ${{ steps.claude-agent.outputs.execution_file }}
          retention-days: 7
