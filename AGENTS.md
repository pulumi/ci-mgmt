# CI Management Repository - AI Agent Guide

This repository generates GitHub Actions workflows, Makefiles, and configuration files for ~86 Pulumi provider repositories. This guide is optimized for AI agent consumption to work effectively with this codebase.

---

## CRITICAL: Bridged vs Native Providers

This is THE most important architectural distinction you must understand.

### Quick Decision Tree
- **Does this provider wrap a Terraform provider?** → Bridged (e.g., pulumi-aws, pulumi-docker)
- **Does it implement logic directly?** → Native (e.g., pulumi-kubernetes, pulumi-command)

### Key Differences

| Aspect | Bridged | Native |
|--------|---------|--------|
| **Makefile** | Generated by ci-mgmt | Custom (provider implements) |
| **Workflows** | Modular, reusable workflows | Self-contained workflows |
| **Template dirs** | `base + internal + bridged + all` | `native + internal + all` |
| **Code generation** | Uses tfgen (Terraform bridge) | Provider-specific generators |
| **Why different** | Consistent Terraform bridge pattern | Highly variable implementations |
| **Examples** | aws, gcp, azure, docker, cloudflare | kubernetes, command, docker-build |

### Common Mistake to Avoid
- ❌ **Wrong**: Using `base` template for native providers → Conflicts with custom Makefile
- ✓ **Correct**: Native providers must use `native` template (which excludes base)

The `base` template includes a generated Makefile that assumes Terraform bridge patterns. Native providers implement their own Makefiles, so they cannot use the base template.

---

## Architecture Overview

### Repository Structure

```
ci-mgmt/
├── provider-ci/                  # Go CLI tool
│   ├── main.go                   # Entry point
│   ├── internal/
│   │   ├── cmd/                  # Cobra CLI commands
│   │   └── pkg/
│   │       ├── templates/        # Template files (7 directories)
│   │       ├── templates.go      # Template composition logic
│   │       ├── config.go         # .ci-mgmt.yaml schema
│   │       ├── generate.go       # Core generation engine
│   │       └── migrations/       # Post-generation transformations (10 active migrations)
│   ├── test-providers/           # 15 test providers for validation
│   └── providers.json            # Inventory of managed providers
├── .github/workflows/            # Deployment and validation workflows
└── infra/providers/              # Pulumi program for branch protections
```

### Template Composition System

Templates combine multiple directories in a specific order (later templates override earlier ones):

**Bridged Provider Types:**
```
bridged-provider:           base + internal + bridged + internal-bridged + all
external-bridged-provider:  base + bridged + all
```

**Native Provider Types:**
```
native:                     native + internal + all
external-native-provider:   native + all
```

**Other Types:**
```
generic:                    base + internal + all
parameterized-go:           base + parameterized-go + all
```

### Template Directories

Located in `./provider-ci/internal/pkg/templates/`:

- **all/** - Final overrides, used by ALL provider types
- **base/** - Git config, reusable workflows, Makefile (for bridged only)
- **internal/** - Code of Conduct, issue templates, upgrade configs (Pulumi-owned)
- **bridged/** - Makefile for bridged providers
- **internal-bridged/** - Upgrade config for internal bridged providers
- **native/** - Complete workflows for native providers (no Makefile)
- **parameterized-go/** - Simple parameterized Go provider template

### Generation Pipeline

1. **Load Configuration**: Read `.ci-mgmt.yaml` from provider repo
2. **Determine Template**: Select template directories based on `template:` field (defaults to `bridged-provider`)
3. **Set Defaults**: GenName=tfgen for bridged, "gen" for others; TestFolder="examples"
4. **Clean Old Files**: If `clean-github-workflows: true`, remove old workflows
5. **Render Templates**: Process files using Go text/template with `#{{ }}#` delimiters
6. **Apply Migrations**: Run 10 active migration modules in `internal/pkg/migrations/`
7. **Validate**: Outputs must pass actionlint checks

### Template Rendering

- **Engine**: Go's `text/template` with custom delimiters `#{{ }}#` (not standard `{{ }}`)
- **Why custom delimiters**: Avoids conflicts with GitHub Actions expressions `${{ }}`
- **Context available**:
  - `.Repository` - Full repo name (e.g., `pulumi/pulumi-aws`)
  - `.ProjectName` - Project name without org (e.g., `pulumi-aws`)
  - `.Config` - Unmarshalled `.ci-mgmt.yaml` configuration
  - `.Splices` - Pre-rendered template fragments from `.splice` files
- **Functions**: All Sprig functions + custom (toYaml, renderEscStep, renderGlobalEnv, etc.)

---

## Working with This Repository

### Standard Validation Workflow

**When making ANY changes to templates or generation logic:**

```bash
cd provider-ci
make clean && make all
```

This runs (takes 5-10 minutes, use 10m timeout):
1. `go build` - Compiles provider-ci CLI
2. `test-go` - Runs Go unit tests
3. `test-providers` - Regenerates all 15 test providers deterministically
4. `actionlint` - Validates generated workflow syntax
5. `format` - Formats Go code
6. `lint` - Runs golangci-lint

**After running, check git status:**
```bash
git status
git diff
```

Only files you intended to change should be modified. Unexpected changes indicate:
- Template changes affected more providers than expected
- Migration modified files unexpectedly
- Need to review and potentially adjust changes

### Testing a Single Provider

For faster iteration during development:

```bash
cd provider-ci
make test-provider/aws    # Regenerates aws test provider with debug output
make lint-providers/aws   # Just validates aws workflows
```

### Testing Against a Real Provider Locally

```bash
cd provider-ci
./bin/provider-ci generate \
  --name pulumi/pulumi-aws \
  --template bridged-provider \
  --config /path/to/pulumi-aws/.ci-mgmt.yaml \
  --out /path/to/pulumi-aws
```

Then review diffs in the real provider repo to see actual impact.

---

## For AI Agents: Common Patterns

### When User Says "Update workflows"

**Decision Path:**
1. **Determine provider type** - Bridged or native? (Check their .ci-mgmt.yaml or providers.json)
2. **Identify template directories** - Which dirs apply based on template type?
3. **Make changes** - Edit template files in `provider-ci/internal/pkg/templates/`
4. **Validate** - Run `cd provider-ci && make all` (use 10m timeout)
5. **Review impact** - Check git diff in `test-providers/` to see how changes affected generated files

**Example:**
```
User: "Add a new environment variable to all bridged provider builds"

Steps:
1. Type: Affects bridged providers
2. Templates: Modify base/.github/workflows/ or bridged/
3. Edit: Add env var to build_provider.yml template
4. Validate: cd provider-ci && make all
5. Review: git diff test-providers/aws/.github/workflows/build_provider.yml
```

### When User Says "Add new workflow"

**Decision Path:**
- **Applies to all providers?** → Add to `templates/all/.github/workflows/`
- **Only bridged providers?** → Add to `templates/base/.github/workflows/` or `templates/bridged/.github/workflows/`
- **Only native providers?** → Add to `templates/native/.github/workflows/`
- **Specific provider only?** → Either:
  - Create provider-specific template directory (rare)
  - Use config hooks in `.ci-mgmt.yaml` (actions.preBuild, actions.postTest, etc.)

**Remember**: Workflow files use `#{{ }}#` delimiters for templates, but GitHub Actions expressions still use `${{ }}`

### When User Says "Test changes"

**Standard workflow:**
```bash
# 1. Full validation (REQUIRED before PR)
cd provider-ci && make all

# 2. Check for unexpected changes
git status
git diff

# 3. Review specific provider impacts
git diff test-providers/aws/.github/workflows/
git diff test-providers/kubernetes/.github/workflows/

# 4. Optional: Test against real provider
./bin/provider-ci generate --config /path/to/real-provider/.ci-mgmt.yaml --out /path/to/real-provider
```

### When User Says "Fix lint errors" or "Fix actionlint"

**Common actionlint issues:**
1. **Invalid workflow syntax** - Check YAML indentation and structure
2. **Unknown action version** - Verify action exists at specified version
3. **Invalid expression** - Check GitHub Actions expressions syntax
4. **Conditional issues** - Verify if/needs conditions

**Debug:**
```bash
# Run actionlint on specific provider
cd provider-ci/test-providers/aws
actionlint .github/workflows/*.yml
```

**Note**: `.github/actionlint.yaml` configures ignoring dynamic ESC outputs

### When Encountering Errors

**Error patterns and solutions:**

- **"Template not found"** → Check `getTemplateDirs()` in `provider-ci/internal/pkg/templates.go`
- **"Actionlint failed"** → Check workflow syntax in generated test-providers files, review actionlint output
- **"Make failed" / "Timeout"** → Increase timeout to 10m (see mise.toml note in user's CLAUDE.md)
- **"Git dirty after generation"** → Migrations modified unexpected files, review `internal/pkg/migrations/`
- **"Syntax error in template"** → Check delimiters (use `#{{ }}#` not `{{ }}`), verify template syntax
- **"Test provider X failed"** → Check that provider's .ci-mgmt.yaml, review generated files

---

## Strategic Goals (Long-term Vision)

When making changes, align with these long-term objectives:

### Goal 1: Make Workflows "Dumb"

**Rationale**: Enables providers in any language, keeps business logic in provider not workflows

**Good Examples:**
```yaml
# ✓ Language-agnostic
- run: make test
- run: make build
- run: make publish_nodejs
```

**Bad Examples:**
```yaml
# ❌ Assumes Go
- run: go test ./...
- run: go build -o bin/provider

# ❌ Tool-specific
- run: goreleaser release --snapshot
- run: pytest tests/
```

**Decision Question**: "Could this work if the provider was written in Python instead of Go?"

**When making changes**: Prefer calling make targets over direct tool invocation. If you need to add Go-specific logic, consider whether it should be in the Makefile instead.

### Goal 2: Consolidate Bridged & Native

**Rationale**: Reduces maintenance burden, increases consistency across many providers

**Look for opportunities to:**
- Move duplicated workflow logic from `native/*.yml` to shared templates
- Identify native-specific patterns that could be generalized
- Restructure native workflows to more closely match bridged patterns
- Eliminate native-only workflows by moving logic to shared locations

**Example consolidation:**
```
Before: native/build.yml has 200 lines of custom build logic
After:  native/build.yml calls reusable base/build_provider.yml
        Native providers implement standardized Makefile targets
```

### Goal 3: Composable Makefiles

**Rationale**: Current blocker for unifying bridged and native - native providers can't use generated Makefiles

**The Problem:**
- **Bridged**: Generated Makefile in base template with standard targets (build, test, generate, etc.)
- **Native**: Must implement own Makefile with provider-specific logic (highly variable)
- **Conflict**: Can't merge because no override mechanism exists

**Long-term Solution:**
- Generate default make targets for BOTH bridged AND native providers
- Allow providers to override specific targets while keeping others
- Example: Default `make test` runs `go test ./...`, but kubernetes provider overrides with custom test logic

**Current Workaround:**
- Bridged providers get generated Makefile (consistent pattern)
- Native providers implement entire Makefile (full control, but inconsistent)

**When making changes**: If you're adding a new make target to bridged providers, consider how it could work for native providers too. Can it be parameterized? Can providers override it?

---

## Validation & Testing

### Pre-PR Checklist

Before creating a PR, ensure:

1. ✓ **Build passes**: `cd provider-ci && make all` succeeds (use 10m timeout)
2. ✓ **Git clean**: `git status` shows only intended changes
3. ✓ **Actionlint passes**: Workflows validate successfully (included in `make all`)
4. ✓ **Test providers updated**: All 15 test providers regenerate deterministically
5. ✓ **Diffs reviewed**: Check generated workflow diffs in `test-providers/`
6. ✓ **Migrations tested**: If adding migration, test against real provider locally
7. ✓ **Docs updated**: If making large changes or refactors, update CLAUDE.md (and AGENTS.md, which is a symlink to it) to reflect new architecture

### What Each Test Validates

**`make test-go`**
- Unit tests for generation logic
- Config parsing and validation
- Template composition correctness

**`make test-providers`**
- All 15 test providers regenerate successfully
- Generation is deterministic (same input → same output)
- No unexpected file changes

**`actionlint`**
- Workflow syntax is valid YAML
- GitHub Actions references exist
- Conditional logic is valid
- Expressions are well-formed

**Downstream CI (automatic)**
- Deploy to xyz and pulumi-provider-boilerplate test repos
- Run full provider CI pipeline
- Verify tests pass with generated workflows

### Test Providers

The 15 test providers in `provider-ci/test-providers/`:

**Bridged**: aws, cloudflare, docker, eks, xyz
**Native**: command, docker-build, kubernetes, kubernetes-cert-manager, kubernetes-coredns, kubernetes-ingress-nginx
**Special**: aws-native, pulumi-provider-boilerplate, pulumiservice, terraform-module

**Key Insight**: `.ci-mgmt.yaml` files in test providers are manually maintained (not regenerated). They define the "input" that drives template generation. Everything else is generated output.

---

## Quick Reference

### Key Files and Their Purposes

**Template System:**
- `provider-ci/internal/pkg/templates.go` - Template composition logic (`getTemplateDirs()`)
- `provider-ci/internal/pkg/templates/` - Template directories (11 types)
- `provider-ci/internal/pkg/config.go` - `.ci-mgmt.yaml` schema definition
- `provider-ci/internal/pkg/generate.go` - Core generation engine
- `provider-ci/internal/pkg/defaults.go` - Default tool versions and configs

**Migrations:**
- `provider-ci/internal/pkg/migrations/migrations.go` - Migration registry (10 active migrations)
- `provider-ci/internal/pkg/migrations/*.go` - Individual migration modules (12 files)

**Testing & Validation:**
- `provider-ci/Makefile` - Build and test orchestration
- `provider-ci/test-providers/` - 15 test provider configurations
- `.github/workflows/test-provider-ci.yml` - PR validation workflow
- `.github/actionlint.yaml` - Workflow validation configuration

**Deployment:**
- `.github/workflows/update-workflows.yml` - Reusable deployment workflow
- `.github/workflows/update-workflows-ecosystem-providers.yml` - Nightly all-provider updates
- `.github/workflows/update-workflows-single-bridged-provider.yml` - Manual single provider updates
- `provider-ci/providers.json` - Inventory of managed providers (~86 as of early 2026)

### Common Tasks

**Regenerate all test providers:**
```bash
cd provider-ci && make gen
```

**Add new migration:**
1. Create `provider-ci/internal/pkg/migrations/yourmigration.go`
2. Implement `Migration` interface: `Name() string`, `Migrate(templateName, outDir string) error`, `ShouldRun(templateName string) bool`
3. Register in `migrations.go`
4. Test: `make test-providers`

**Add new template directory:**
1. Create directory in `provider-ci/internal/pkg/templates/newtemplate/`
2. Add to `getTemplateDirs()` in `templates.go`
3. Add template type to config.go if needed
4. Test: `make test-providers`

**Update provider configs from real repos:**
```bash
cd provider-ci && make update-provider-configs
```
This fetches latest `.ci-mgmt.yaml` from real provider repos to keep test configs in sync.

**Deploy to single provider (manual):**
- Trigger `.github/workflows/update-workflows-single-bridged-provider.yml` workflow
- Specify provider name

**Deploy to all providers (use caution):**
- Trigger `.github/workflows/update-workflows-ecosystem-providers.yml`
- Or wait for nightly scheduled run (5 AM UTC)
- Rate limited to 1 provider/second

### Debug Commands

**View template composition for a provider:**
```bash
cd provider-ci
# Check templates.go getTemplateDirs() function
# Or run with debug flag
./bin/provider-ci generate --config test-providers/aws/.ci-mgmt.yaml --out /tmp/test-aws
```

**Test single provider with full output:**
```bash
cd provider-ci
make test-provider/aws 2>&1 | tee /tmp/aws-generation.log
```

**Check what files a template generates:**
```bash
ls -la provider-ci/internal/pkg/templates/base/.github/workflows/
ls -la provider-ci/internal/pkg/templates/native/.github/workflows/
```

**Validate workflows manually:**
```bash
cd provider-ci/test-providers/aws
actionlint .github/workflows/*.yml
```

---

## Important Notes for AI Agents

### Keeping AGENTS.md Up-to-Date

AGENTS.md is a symlink to CLAUDE.md - they are the same file. **Agents must keep this file accurate** after making significant changes:

- **Template changes**: Update the Template Composition System and Template Directories sections if you add, remove, or rename template directories or types
- **New provider types**: Add them to `getTemplateDirs()` and document in the Template Composition System section
- **Migration changes**: Update the migration count and interface documentation if you add or remove migrations
- **Test provider changes**: Update the test provider list and count when providers are added or removed
- **Provider count**: Update the providers.json count estimate if it changes significantly

When in doubt, audit the actual codebase to verify documented counts and structures remain accurate. The most important things to keep correct are the template composition tables (incorrect template dirs cause broken generation) and the migration interface (incorrect interface causes broken migrations).

### Timeouts
- `make all` takes 5-10 minutes (16 providers × generation × validation)
- Always use generous timeouts (1m recommended)
- User's global CLAUDE.md already specifies this for the repo

### Test Provider .ci-mgmt.yaml Files
- **DO NOT** edit generated files in test-providers (Makefiles, workflows, etc.)
- **ONLY** edit `.ci-mgmt.yaml` to test configuration changes
- Generated files are committed for PR diff visibility
- Always run `make gen` after changing `.ci-mgmt.yaml`

### Template Syntax
- Use `#{{ }}#` delimiters for Go templates
- GitHub Actions expressions still use `${{ }}`
- Example: `#{{ .Config.Provider }}#` in template → `pulumi-aws` in output
- Example: `${{ github.sha }}` stays as-is (GitHub Actions expression)

### Makefile Generation Conflict
- **Critical**: Native providers CANNOT use base template (it includes generated Makefile)
- Native providers must implement their own Makefile
- This is the main architectural reason for bridged/native split
- Long-term goal: Make Makefiles composable to unify the templates

### Migrations
- Migrations run AFTER template generation
- Allow modifying files that aren't directly templated
- Can be skipped with `--skip-migrations` flag
- Each migration has `ShouldRun()` to determine applicability

### Downstream Deployment
- PRs automatically deploy to test repos (xyz, pulumi-provider-boilerplate)
- Production deployment happens on merge or nightly schedule
- Rate limited to avoid GitHub API throttling
- Creates PRs in downstream repos (not direct commits)

---

## Summary

This repository uses a **template composition system** to maintain consistency across ~86 Pulumi providers. The critical distinction is **bridged vs native** providers - bridged wrap Terraform providers and get generated Makefiles, while native providers implement logic directly and provide custom Makefiles. Always validate changes with `make all`, review test-provider diffs, and align with strategic goals: dumb workflows, consolidation, and composable Makefiles.
