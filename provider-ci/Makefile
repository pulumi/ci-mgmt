SHELL := /bin/bash -o pipefail
NAME ?= all
PROVIDERS := $(patsubst %/, %, $(wildcard providers/*/))
PROVIDER_REPOS := $(addsuffix /repo, $(PROVIDERS))

CPUS ?= $(shell sysctl -n hw.ncpu || echo 1)
MAKEFLAGS += --jobs=$(CPUS)

# These targets are versioned to cause Make to rebuild them when the version changes.
ACTIONLINT_VERSION := 1.7.7
ACTIONLINT := bin/actionlint-$(ACTIONLINT_VERSION)

.PHONY: all test gen ensure
all: ensure test format lint
test: test-go test-providers
gen: test-providers
ensure:: bin/provider-ci $(ACTIONLINT)

bin/provider-ci: $(shell find internal -type f)
	go build -o bin/provider-ci

$(ACTIONLINT):
	GOBIN=$(abspath bin) go install github.com/rhysd/actionlint/cmd/actionlint@v1.7.7
	mv bin/actionlint $(ACTIONLINT)

# Basic helper targets.
.PHONY: test-go clean lint format
test-go:
	go test -v ./...

clean:
	rm -rf bin

lint:
	golangci-lint run

format:
	go fmt ./...

# We check in a subset of provider workflows so template changes are visible in PR diffs.
#
# This provides an example of generated providers for PR reviewers. This target
# regenerates them. Only workflows generated by this target should be checked in. Workflow
# files for other bridged provider repositories should be ephemeral.
.PHONY: test-providers test-provider/%

test-providers: test-provider/aws test-provider/docker test-provider/cloudflare test-provider/eks test-provider/terraform-module test-provider/command test-provider/aws-native test-provider/kubernetes-coredns test-provider/docker-build test-provider/kubernetes test-provider/kubernetes-cert-manager test-provider/kubernetes-ingress-nginx test-provider/xyz test-provider/pulumi-provider-boilerplate test-provider/pulumiservice

# 1. Delete all files except the .ci-mgmt.yaml file and run the provider-ci generate command.
# 2. Copy the generated provider repository to a temporary git repo and run actionlint on it.
test-provider/%: PROVIDER_NAME = $*
test-provider/%: bin/provider-ci $(ACTIONLINT)
	cd test-providers/$(PROVIDER_NAME) && \
	find . -type f ! -name '.ci-mgmt.yaml' ! -name "*.go" ! -name 'go.mod' ! -name 'provider/go.mod' ! -name 'mise.toml'  ! -name '.golangci.yml' -delete && \
		git init && \
		../../bin/provider-ci generate 2>&1 | sed "s/^/[$(PROVIDER_NAME)] /"
	@mkdir -p bin/test-provider
	@rm -rf bin/test-provider/$(PROVIDER_NAME)
	@cp -r test-providers/$(PROVIDER_NAME) bin/test-provider
	@cd bin/test-provider/$(PROVIDER_NAME)
	(set -o pipefail && cd bin/test-provider/$(PROVIDER_NAME) && ../../../$(ACTIONLINT) -config-file ../../../../.github/actionlint.yaml | sed "s/^/[$(PROVIDER_NAME)] /")

# Fetch the latest .ci-mgmt.yaml from the provider repositories ready for testing.
update-provider-configs:
	curl "https://raw.githubusercontent.com/pulumi/pulumi-aws/master/.ci-mgmt.yaml" > ./test-providers/aws/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-cloudflare/master/.ci-mgmt.yaml" > ./test-providers/cloudflare/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-docker/master/.ci-mgmt.yaml" > ./test-providers/docker/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-aws-native/master/.ci-mgmt.yaml" > ./test-providers/aws-native/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-command/master/.ci-mgmt.yaml" > ./test-providers/command/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-eks/master/.ci-mgmt.yaml" > ./test-providers/eks/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-docker-build/master/.ci-mgmt.yaml" > ./test-providers/docker-build/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-kubernetes/master/.ci-mgmt.yaml" > ./test-providers/kubernetes/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-kubernetes-cert-manager/master/.ci-mgmt.yaml" > ./test-providers/kubernetes-cert-manager/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-kubernetes-coredns/master/.ci-mgmt.yaml" > ./test-providers/kubernetes-coredns/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-kubernetes-ingress-nginx/master/.ci-mgmt.yaml" > ./test-providers/kubernetes-ingress-nginx/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-provider-boilerplate/master/.ci-mgmt.yaml" > ./test-providers/pulumi-provider-boilerplate/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-pulumiservice/main/.ci-mgmt.yaml" > ./test-providers/pulumiservice/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-terraform-module/master/.ci-mgmt.yaml" > ./test-providers/terraform-module/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-xyz/main/.ci-mgmt.yaml" > ./test-providers/xyz/.ci-mgmt.yaml
