NAME ?= all
PROVIDERS := $(patsubst %/, %, $(wildcard providers/*/))
PROVIDER_REPOS := $(addsuffix /repo, $(PROVIDERS))

# These targets are versioned to cause Make to rebuild them when the version changes.
ACTIONLINT_VERSION := 1.7.7
ACTIONLINT := bin/actionlint-$(ACTIONLINT_VERSION)

.PHONY: all test gen ensure
all: ensure test format lint
test: test-providers
gen: test-providers
ensure:: bin/provider-ci $(ACTIONLINT)

bin/provider-ci: $(shell find internal -type f)
	go build -o bin/provider-ci

$(ACTIONLINT):
	GOBIN=$(abspath bin) go install github.com/rhysd/actionlint/cmd/actionlint@v1.7.7
	mv bin/actionlint $(ACTIONLINT)

# Basic helper targets.
.PHONY: clean lint format
clean:
	rm -rf bin

lint:
	golangci-lint run

format:
	go fmt ./...

# We check in a subset of provider workflows so template changes are visible in PR diffs.
#
# This provides an example of generated providers for PR reviewers. This target
# regenerates them. Only workflows generated by this target should be checked in. Workflow
# files for other bridged provider repositories should be ephemeral.
.PHONY: test-providers test-provider/% test-provider/native/%

test-providers: test-provider/aws test-provider/docker test-provider/cloudflare test-provider/acme test-provider/eks test-provider/terraform-module test-provider/native/command test-provider/native/aws-native test-provider/native/kubernetes-coredns test-provider/native/docker-build test-provider/native/kubernetes test-provider/native/kubernetes-cert-manager test-provider/native/kubernetes-ingress-nginx

# 1. Delete all files except the .ci-mgmt.yaml file and run the provider-ci generate command.
# Skip actionlint while we migrate from the native-provider-ci to provider-ci.
test-provider/native/%: PROVIDER_NAME = $*
test-provider/native/%: bin/provider-ci
	cd test-providers/$(PROVIDER_NAME) && \
		find . -type f ! -name '.ci-mgmt.yaml' -delete && \
		../../bin/provider-ci generate --skip-migrations

# 1. Delete all files except the .ci-mgmt.yaml file and run the provider-ci generate command.
# 2. Copy the generated provider repository to a temporary git repo and run actionlint on it.
test-provider/%: PROVIDER_NAME = $*
test-provider/%: bin/provider-ci $(ACTIONLINT)
	cd test-providers/$(PROVIDER_NAME) && \
		find . -type f ! -name '.ci-mgmt.yaml' -delete && \
		../../bin/provider-ci generate --skip-migrations
	mkdir -p bin/test-provider
	rm -rf bin/test-provider/$(PROVIDER_NAME)
	cp -r test-providers/$(PROVIDER_NAME) bin/test-provider
	cd bin/test-provider/$(PROVIDER_NAME) && git init
	cd bin/test-provider/$(PROVIDER_NAME) && ../../../$(ACTIONLINT) -config-file ../../../../.github/actionlint.yaml

# Fetch the latest .ci-mgmt.yaml from the provider repositories ready for testing.
update-provider-configs:
	curl "https://raw.githubusercontent.com/pulumi/pulumi-aws/master/.ci-mgmt.yaml" > ./test-providers/aws/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-cloudflare/master/.ci-mgmt.yaml" > ./test-providers/cloudflare/.ci-mgmt.yaml
	curl "https://raw.githubusercontent.com/pulumi/pulumi-docker/master/.ci-mgmt.yaml" > ./test-providers/docker/.ci-mgmt.yaml
