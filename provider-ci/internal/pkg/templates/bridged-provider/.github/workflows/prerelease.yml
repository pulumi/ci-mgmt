# WARNING: This file is autogenerated - changes will be overwritten if not made via https://github.com/pulumi/ci-mgmt

env:
  IS_PRERELEASE: true
#{{ .Config.env | toYaml | indent 2 }}#
jobs:
  prerequisites:
    uses: ./.github/workflows/prerequisites.yml
    secrets: inherit
    with:
      default_branch: ${{ github.event.repository.default_branch }}
      is_pr: ${{ github.event_name == 'pull_request' }}
      is_automated: ${{ github.actor == 'dependabot[bot]' }}

  build_provider:
    uses: ./.github/workflows/build_provider.yml
    needs: prerequisites
    secrets: inherit
    with:
      version: ${{ needs.prerequisites.outputs.version }}

  build_sdk:
    name: build_sdk
    needs: prerequisites
    uses: ./.github/workflows/build_sdk.yml
    secrets: inherit
    with:
      version: ${{ needs.prerequisites.outputs.version }}

  test:
    name: Test
    needs:
      - prerequisites
      - build_sdk
    uses: ./.github/workflows/test.yml
    secrets: inherit
    with:
      version: ${{ needs.prerequisites.outputs.version }}

  #{{ if .Config.lint -}}#
  lint:
    name: lint
    uses: ./.github/workflows/lint.yml
    secrets: inherit
  #{{ end -}}#

  license_check:
    name: License Check
    uses: ./.github/workflows/license.yml
    secrets: inherit

  publish:
    name: publish
    needs:
      - prerequisites
      - build_provider
      - test
      - license_check
      #{{- range $action, $_ := .Config.extraTests }}#
      - #{{ $action }}#
      #{{- end }}#
    uses: ./.github/workflows/publish.yml
    secrets: inherit
    with:
      version: ${{ needs.prerequisites.outputs.version }}
      isPrerelease: true

#{{- if .Config.extraTests }}#
#{{ .Config.extraTests | toYaml | indent 2 }}#
#{{ end }}#

name: prerelease
on:
  push:
    tags:
    - v*.*.*-**
#{{- if .Config.testMasterAndReleaseWorkflows }}#
  pull_request:
#{{ end }}#
