# WARNING: This file is autogenerated - changes will be overwritten if not made via https://github.com/pulumi/ci-mgmt

env:
  #{{- if eq .Config.provider "null" }}#
  PROVIDER: "#{{ .Config.provider }}#"
  #{{- else }}#
  PROVIDER: #{{ .Config.provider }}#
  #{{- end }}#
  PULUMI_EXTRA_MAPPING_ERROR: #{{ index .Config "fail-on-extra-mapping" }}#
  PULUMI_MISSING_MAPPING_ERROR: #{{ index .Config "fail-on-missing-mapping" }}#
#{{ .Config.env | toYaml | indent 2 }}#
jobs:
  resync_build:
    name: resync-build
    runs-on: #{{ .Config.runner.default }}#
    steps:
    - name: Checkout Repo
      uses: #{{ .Config.actionVersions.checkout }}#
      #{{- if .Config.checkoutSubmodules }}#
      with:
        submodules: #{{ .Config.checkoutSubmodules }}#
      #{{- end }}#
    - name: Checkout repo
      uses: #{{ .Config.actionVersions.checkout }}#
      with:
        path: ci-mgmt
        repository: pulumi/ci-mgmt
    - id: run-url
      name: Create URL to the run output
      run:  echo "run-url=https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> "$GITHUB_OUTPUT"
    - name: Install Go
      uses: #{{ .Config.actionVersions.setupGo }}#
      with:
        go-version: "#{{ .Config.toolVersions.go }}#"
        cache-dependency-path: |
          sdk/go.sum
    - name: Install pulumictl
      uses: #{{ .Config.actionVersions.installGhRelease }}#
      with:
        tag: #{{ .Config.actionVersions.pulumictlTag }}#
        repo: pulumi/pulumictl
#{{ .Config.actions.setupPulumi | toYaml | indent 4 }}#
    - name: Setup DotNet
      uses: #{{ .Config.actionVersions.setupDotNet }}#
      with:
        dotnet-version: "#{{ .Config.toolVersions.dotnet }}#"
    - name: Setup Node
      uses: #{{ .Config.actionVersions.setupNode }}#
      with:
        node-version: "#{{ .Config.toolVersions.node }}#"
        registry-url: https://registry.npmjs.org
    - name: Setup Python
      uses: #{{ .Config.actionVersions.setupPython }}#
      with:
        python-version: "#{{ .Config.toolVersions.python }}#"
    - name: Sync with ci-mgmt
      run: cp -r "ci-mgmt/provider-ci/providers/$PROVIDER/repo/." .
    - name: Remove ci-mgmt directory
      run: rm -rf ci-mgmt
    - name: Required entries for gitignore
      run: |-
        cat <<- EOF > "$RUNNER_TEMP/gitignore"
        sdk/java/build
        sdk/java/.gradle
        sdk/java/gradle
        sdk/java/gradlew
        sdk/java/gradlew.bat
        EOF
      shell: bash
    - name: Adding missing lines to .gitignore
      run: |
        comm -23 <(sort "$RUNNER_TEMP/gitignore") <(sort .gitignore) >> .gitignore.temp
        cat .gitignore.temp >> .gitignore
        rm .gitignore.temp
      shell: bash
    - name: Build
      run: make build
    - name: Create PR (no linked issue)
      uses: peter-evans/create-pull-request@v3.12.0
      with:
        author: pulumi-bot <bot@pulumi.com>
        base: #{{ .Config.providerDefaultBranch }}#
        body: This pull request was generated automatically by the resync-build workflow
          in this repository.
        branch: pulumi-bot/resync-${{ github.run_id}}
        commit-message: Resync build for pulumi-${{ env.PROVIDER }}
        committer: pulumi-bot <bot@pulumi.com>
        labels: impact/no-changelog-required
        team-reviewers: platform-integrations
        title: Fix up build for pulumi-${{ env.PROVIDER }}
        token: ${{ secrets.PULUMI_BOT_TOKEN }}
name: Resync build
on:
  workflow_dispatch:
    inputs:
      automerge:
        default: false
        description: Mark created PR for auto-merging?
        required: true
        type: boolean
