#{{ if .Config.CheckUpstreamUpgrade -}}#
# WARNING: This file is autogenerated - changes will be overwritten when regenerated by https://github.com/pulumi/ci-mgmt

name: Upgrade provider
on:
  workflow_dispatch:
    inputs:
      version:
        description: |
          The version of the upstream provider to upgrade to, without the 'v' prefix

          If no version is specified, it will be inferred from the upstream provider's release tags.
        required: false
        type: string
      upgradeProviderVersion:
        description: |
          Version of upgrade-provider to use. This must be a valid git reference in the pulumi/upgrade-provider repo. Defaults to "main"

          See https://go.dev/ref/mod#versions for valid versions. E.g. "v0.1.0", "main", "da25dec".
        default: main
        type: string
  schedule:
    # 3 AM UTC ~ 8 PM PDT / 7 PM PST daily. Time chosen to run during off hours.
    - cron: 0 3 * * *

env:
#{{ .Config | renderGlobalEnv | indent 2 }}#

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write # For ESC secrets.

jobs:
  upgrade_provider:
    name: upgrade-provider
    runs-on: #{{ .Config.Runner.Default }}#
    steps:
      #{{- if .Config.FreeDiskSpaceBeforeBuild }}#
      # Run as first step so we don't delete things that have just been installed
      - name: Free Disk Space (Ubuntu)
        uses: #{{ .Config.ActionVersions.FreeDiskSpace }}#
        with:
          tool-cache: false
          swap-storage: false
          dotnet: false
      #{{- end }}#
      - name: Checkout Repo
        uses: #{{ .Config.ActionVersions.Checkout }}#
        with:
          #{{- if .Config.CheckoutSubmodules }}#
          submodules: #{{ .Config.CheckoutSubmodules }}#
          #{{- end }}#
          persist-credentials: false # Conflicts with app auth token.
      #{{- .Config | renderEscStep | indent 6 }}#
#{{- if .Config.GitHubApp.Enabled }}#
      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-auth
        with:
          app-id: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_APP_ID }}
          private-key: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
#{{- end }}#
      - name: Setup mise
        uses: jdx/mise-action@c1a019b8d2586943b4dbebc456323b516910e310
        env:
          MISE_FETCH_REMOTE_VERSIONS_TIMEOUT: 30s
        with:
          version: #{{ .Config.MiseVersion }}#
          github_token: #{{ if .Config.GitHubApp.Enabled }}#${{ steps.app-auth.outputs.token }}#{{ else }}#${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}#{{ end }}#
          # only saving the cache in the prerequisites job
          cache_save: false
      - name: Install upgrade-provider
        run: go install github.com/pulumi/upgrade-provider@${{ inputs.upgradeProviderVersion || 'main' }}
        shell: bash
      - name: "Set up git identity"
        run: |
          git config --global user.name 'bot@pulumi.com'
          git config --global user.email 'bot@pulumi.com'
        shell: bash
      - name: Create issues for new upstream version
        if: inputs.version == ''
        id: upstream_version
        # This step outputs `latest_version` if there is a pending upgrade
        run: upgrade-provider "$REPO" --kind=check-upstream-version
        env:
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_TOKEN || steps.esc-secrets.outputs.PULUMI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
        shell: bash
      - name: Calculate target version
        id: target_version
        # Prefer the manually specified version if it exists
        # upstream_version will be empty if the provider is up-to-date
        run: echo "version=${{ github.event.inputs.version || steps.upstream_version.outputs.latest_version }}" >> "$GITHUB_OUTPUT"
        shell: bash
      - name: Call upgrade provider action
        id: upgrade_provider
        if: steps.target_version.outputs.version != ''
        uses: #{{ .Config.ActionVersions.UpgradeProviderAction }}#
        with:
          kind: provider
          email: bot@pulumi.com
          username: pulumi-bot
          automerge: #{{ .Config.AutoMergeProviderUpgrades }}#
          target-version: ${{ steps.target_version.outputs.version }}
          allow-missing-docs: #{{ .Config.AllowMissingDocs }}#
        env:
          GH_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_TOKEN || steps.esc-secrets.outputs.PULUMI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
#{{ end -}}#
