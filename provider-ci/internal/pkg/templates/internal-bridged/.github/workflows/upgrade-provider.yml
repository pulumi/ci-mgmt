#{{ if .Config.CheckUpstreamUpgrade -}}#
# WARNING: This file is autogenerated - changes will be overwritten when regenerated by https://github.com/pulumi/ci-mgmt

name: Upgrade provider
on:
  workflow_dispatch:
    inputs:
      version:
        description: |
          The version of the upstream provider to upgrade to, without the 'v' prefix

          If no version is specified, it will be inferred from the upstream provider's release tags.
        required: false
        type: string
      upgradeProviderVersion:
        description: |
          Version of upgrade-provider to use. This must be a valid git reference in the pulumi/upgrade-provider repo. Defaults to "main"

          See https://go.dev/ref/mod#versions for valid versions. E.g. "v0.1.0", "main", "da25dec".
        default: main
        type: string
  schedule:
    # 3 AM UTC ~ 8 PM PDT / 7 PM PST daily. Time chosen to run during off hours.
    - cron: 0 3 * * *

env:
#{{ .Config | renderGlobalEnv | indent 2 }}#

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write # For ESC secrets.

jobs:
  upgrade_provider:
    name: upgrade-provider
    runs-on: #{{ .Config.Runner.Default }}#
    steps:
      #{{- if .Config.FreeDiskSpaceBeforeBuild }}#
      # Run as first step so we don't delete things that have just been installed
      - name: Free Disk Space (Ubuntu)
        uses: #{{ .Config.ActionVersions.FreeDiskSpace }}#
        with:
          tool-cache: false
          swap-storage: false
          dotnet: false
      #{{- end }}#
      - name: Checkout Repo
        uses: #{{ .Config.ActionVersions.Checkout }}#
        with:
          #{{- if .Config.CheckoutSubmodules }}#
          submodules: #{{ .Config.CheckoutSubmodules }}#
          #{{- end }}#
          persist-credentials: false # Conflicts with app auth token.
      #{{- .Config | renderEscStep | indent 6 }}#
#{{- if .Config.GitHubApp.Enabled }}#
      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-auth
        with:
          app-id: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_APP_ID }}
          private-key: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
#{{- end }}#
      - name: Setup mise
        uses: blampe/mise-action@blampe/plugins
        env:
          MISE_FETCH_REMOTE_VERSIONS_TIMEOUT: 30s
        with:
          version: 2026.1.1
          github_token: #{{ if .Config.GitHubApp.Enabled }}#${{ steps.app-auth.outputs.token }}#{{ else }}#${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}#{{ end }}#
          plugin_install: https://github.com/pulumi/vfox-pulumi
          # only saving the cache in the prerequisites job
          cache_save: false
      - name: Install upgrade-provider
        run: go install github.com/pulumi/upgrade-provider@${{ inputs.upgradeProviderVersion || 'main' }}
        shell: bash
      - name: "Set up git identity"
        run: |
          git config --global user.name 'bot@pulumi.com'
          git config --global user.email 'bot@pulumi.com'
        shell: bash
      - name: Create issues for new upstream version
        if: inputs.version == ''
        id: upstream_version
        # This step outputs `latest_version` if there is a pending upgrade
        run: upgrade-provider "$REPO" --kind=check-upstream-version
        env:
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_TOKEN || steps.esc-secrets.outputs.PULUMI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
        shell: bash
      - name: Calculate target version
        id: target_version
        # Prefer the manually specified version if it exists
        # upstream_version will be empty if the provider is up-to-date
        run: echo "version=${{ github.event.inputs.version || steps.upstream_version.outputs.latest_version }}" >> "$GITHUB_OUTPUT"
        shell: bash
      - name: Call upgrade provider action
        id: upgrade_provider
        if: steps.target_version.outputs.version != ''
        uses: #{{ .Config.ActionVersions.UpgradeProviderAction }}#
        with:
          kind: provider
          email: bot@pulumi.com
          username: pulumi-bot
          automerge: #{{ .Config.AutoMergeProviderUpgrades }}#
          target-version: ${{ steps.target_version.outputs.version }}
          allow-missing-docs: #{{ .Config.AllowMissingDocs }}#
        env:
          GH_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_TOKEN || steps.esc-secrets.outputs.PULUMI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
      - name: Check for existing upgrade failure issue
        id: check_issue
        if: failure() && steps.upgrade_provider.outcome == 'failure'
        run: |
          issue_count=$(gh issue list --search "Workflow failure: Upgrade provider in:title" --state open --json number --jq 'length')
          echo "exists=$([[ $issue_count -gt 0 ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_PROVIDER_AUTOMATION_TOKEN || steps.esc-secrets.outputs.PULUMI_BOT_TOKEN || secrets.GITHUB_TOKEN }}
        shell: bash
      - name: Auto-fix upgrade with Claude
        if: failure() && steps.upgrade_provider.outcome == 'failure' && steps.check_issue.outputs.exists != 'true'
        uses: anthropics/claude-code-action@8341a564b0c1693e9fa29c681852ee3714980098 # v1
        with:
          anthropic_api_key: ${{ steps.esc-secrets.outputs.ANTHROPIC_API_KEY }}
          prompt: |
            The upgrade-provider action failed for ${{ github.repository }}.

            Use the pulumi-upgrade-provider skill to attempt to fix the upgrade.

            Track each unique error you encounter. Stop and fail if:
            - You've attempted the same error 3 times without progress
            - The issue requires human judgment or isn't covered by the skill's error patterns
            - The complexity is escalating with each fix attempt

            If you successfully complete the upgrade, report the PR URL and summarize any fixes applied.
            If you cannot complete the upgrade, summarize what you tried and why it needs human attention.
          claude_args: |
            --max-turns 75
            --allowedTools "Edit,Write,Read,Glob,Grep,Bash(upgrade-provider:*),Bash(./scripts/upstream.sh:*),Bash(git:*),Bash(GIT_EDITOR=*),Bash(make:*),Bash(gh:*),Bash(mkdir:*),Bash(cd:*)"
#{{ end -}}#
