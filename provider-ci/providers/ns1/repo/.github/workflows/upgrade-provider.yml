# WARNING: This file is autogenerated - changes will be overwritten if not made via https://github.com/pulumi/ci-mgmt

env:
  GH_TOKEN: ${{ secrets.PULUMI_BOT_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
jobs:
  upgrade_provider:
    if: ${{ github.event.pull_request.title }} =~ 'Upgrade terraform-provider-'
    name: upgrade-provider
    runs-on: ubuntu-latest
    steps:
    - name: Install Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.20.1
    - name: Install pulumictl
      uses: jaxxstorm/action-install-gh-release@v1.5.0
      with:
        repo: pulumi/pulumictl
    - name: Install Pulumi CLI
      uses: pulumi/action-install-pulumi-cli@v2
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        ref: master
    - name: Install `upgrade-provider`
      run: go install github.com/pulumi/upgrade-provider@latest
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: "7.6"
    - name: Set up git identity
      run: git config --global user.name "Pulumi Bot" && git config--global user.email
        "bot@pulumi.com"
    - name: Run upgrade-provider
      run: upgrade-provider pulumi-ns1 --kind=all
    - env:
        SLACK_CHANNEL: provider-upgrade-status
        SLACK_COLOR: ${{ job.status }}
        SLACK_ICON_EMOJI: ":taco:"
        SLACK_MESSAGE: |-
          Upgrade succeeded: :heart_decoration: 
          View the PR at github.com/pulumi/pulumi-ns1
        SLACK_TITLE: ${{ inputs.provider-name }} upgrade result
        SLACK_USERNAME: provider-bot
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
      name: Notify success
      uses: rtCamp/action-slack-notify@v2
    - env:
        SLACK_CHANNEL: provider-upgrade-status
        SLACK_COLOR: ${{ job.status }}
        SLACK_ICON_EMOJI: ":taco:"
        SLACK_MESSAGE: "Upgrade failed: :sad:"
        SLACK_TITLE: ${{ inputs.provider-name }} upgrade result
        SLACK_USERNAME: provider-bot
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
      if: failure()
      name: Notify failure
      uses: rtCamp/action-slack-notify@v2
name: Upgrade provider
on:
  pull_request:
    types:
    - opened
  workflow_dispatch: {}
