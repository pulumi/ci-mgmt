[task_config.env]
PACK = "docker"
ORG = "pulumi"
PROJECT = "github.com/pulumi/pulumi-docker"
PROVIDER_PATH = "provider/v4"
VERSION_PATH = "provider/v4/pkg/version.Version"
CODEGEN = "pulumi-tfgen-docker"
PROVIDER = "pulumi-resource-docker"
PROVIDER_VERSION = "4.0.0-alpha.0+dev"
TESTPARALLELISM = "10"
GOTESTARGS = ""
PULUMI_CONVERT = "1"
PULUMI_MISSING_DOCS_ERROR = "false"
PULUMI_PROVIDER_BUILD_PARALLELISM = ""

[tasks.setup]
description = "Install toolchain via mise"
run = "mise install -q"

[tasks."install:plugins"]
description = "Install Pulumi CLI plugins required for builds"
run = '''
set -euo pipefail
mkdir -p .pulumi
export PULUMI_HOME="${PULUMI_HOME:-$(pwd)/.pulumi}"
pulumi plugin install converter terraform 1.0.16
pulumi plugin install resource aws 6.8.0
'''
sources = ["scripts/plugins.mk"]
outputs = [".pulumi/plugins"]

[tasks.upstream]
description = "Initialize upstream submodule and apply patches"
run = '''
set -euo pipefail
mkdir -p .make
./scripts/upstream.sh init
touch .make/upstream
'''
sources = ["patches/**", "scripts/upstream.sh"]
outputs = [".make/upstream"]

[tasks."tfgen:build"]
description = "Build the pulumi-tfgen-docker code generator"
depends = ["setup", "upstream"]
run = '''
set -euo pipefail
mkdir -p bin
ldflags="-X ${PROJECT}/${VERSION_PATH}=${PROVIDER_VERSION}"
cd provider
go build ${PULUMI_PROVIDER_BUILD_PARALLELISM} -o ../bin/${CODEGEN} -ldflags "${ldflags}" ${PROJECT}/${PROVIDER_PATH}/cmd/${CODEGEN}
'''
sources = ["provider/**/*.go", "provider/go.mod", "provider/go.sum"]
outputs = ["bin/pulumi-tfgen-docker"]

[tasks."docs:examples"]
description = "Regenerate provider example documentation"
run = '''
set -euo pipefail
cd provider/pkg/docs-gen/examples
go run generate.go ./yaml ./
'''
sources = ["provider/pkg/docs-gen/examples/**/*.go", "provider/pkg/docs-gen/examples/yaml/**"]
outputs = ["provider/pkg/docs-gen/examples"]

[tasks.schema]
description = "Generate schema.json via tfgen"
depends = ["install:plugins", "tfgen:build", "docs:examples"]
run = '''
set -euo pipefail
mkdir -p .pulumi .pulumi/examples-cache
export PULUMI_HOME="${PULUMI_HOME:-$(pwd)/.pulumi}"
export PULUMI_CONVERT="${PULUMI_CONVERT}"
export PULUMI_CONVERT_EXAMPLES_CACHE_DIR="${PULUMI_HOME}/examples-cache"
export PULUMI_DISABLE_AUTOMATIC_PLUGIN_ACQUISITION="${PULUMI_CONVERT}"
export PULUMI_MISSING_DOCS_ERROR="${PULUMI_MISSING_DOCS_ERROR}"
bin/${CODEGEN} schema --out provider/cmd/${PROVIDER}
(cd provider && VERSION=${PROVIDER_VERSION} go generate cmd/${PROVIDER}/main.go)
'''
sources = ["bin/pulumi-tfgen-docker", "provider/cmd/pulumi-resource-docker/**", "provider/pkg/**", "examples/**", "README.md"]
outputs = ["provider/cmd/pulumi-resource-docker/schema.json"]

[tasks.tfgen]
description = "Run schema generation with dependencies"
depends = ["schema"]
run = "true"

[tasks."tfgen:no-deps"]
description = "Generate schema without rebuilding docs"
run = '''
set -euo pipefail
bin/${CODEGEN} schema --out provider/cmd/${PROVIDER}
(cd provider && VERSION=${PROVIDER_VERSION} go generate cmd/${PROVIDER}/main.go)
'''
depends = ["install:plugins", "tfgen:build"]

[tasks.provider]
description = "Build provider binary"
depends = ["schema"]
run = '''
set -euo pipefail
mkdir -p bin
goos="${GOOS:-$(go env GOOS)}"
goarch="${GOARCH:-$(go env GOARCH)}"
ldflags="-X ${PROJECT}/${VERSION_PATH}=${PROVIDER_VERSION}"
cd provider
GOOS="${goos}" GOARCH="${goarch}" CGO_ENABLED=0 go build ${PULUMI_PROVIDER_BUILD_PARALLELISM} -o ../bin/${PROVIDER} -ldflags "${ldflags}" ${PROJECT}/${PROVIDER_PATH}/cmd/${PROVIDER}
'''
sources = ["provider/**/*.go", "provider/go.mod", "provider/go.sum", "provider/cmd/pulumi-resource-docker/schema.json"]
outputs = ["bin/pulumi-resource-docker"]

[tasks."provider:no-deps"]
description = "Build provider binary without validating schema"
run = '''
set -euo pipefail
mkdir -p bin
goos="${GOOS:-$(go env GOOS)}"
goarch="${GOARCH:-$(go env GOARCH)}"
ldflags="-X ${PROJECT}/${VERSION_PATH}=${PROVIDER_VERSION}"
cd provider
GOOS="${goos}" GOARCH="${goarch}" CGO_ENABLED=0 go build ${PULUMI_PROVIDER_BUILD_PARALLELISM} -o ../bin/${PROVIDER} -ldflags "${ldflags}" ${PROJECT}/${PROVIDER_PATH}/cmd/${PROVIDER}
'''

[tasks."generate:dotnet"]
description = "Generate .NET SDK"
depends = ["install:plugins", "tfgen:build"]
run = '''
set -euo pipefail
mkdir -p sdk/dotnet
export PULUMI_HOME="${PULUMI_HOME:-$(pwd)/.pulumi}"
export PULUMI_CONVERT_EXAMPLES_CACHE_DIR="${PULUMI_HOME}/examples-cache"
export PULUMI_CONVERT="${PULUMI_CONVERT}"
export PULUMI_DISABLE_AUTOMATIC_PLUGIN_ACQUISITION="${PULUMI_CONVERT}"
bin/${CODEGEN} dotnet --out sdk/dotnet/
cd sdk/dotnet
printf "module fake_dotnet_module // Exclude this directory from Go tools\n\ngo 1.17\n" > go.mod
echo "${PROVIDER_VERSION}" > version.txt
'''
sources = ["provider/cmd/pulumi-resource-docker/schema.json"]
outputs = ["sdk/dotnet"]

[tasks."build:dotnet"]
description = "Build .NET SDK"
depends = ["generate:dotnet"]
run = '''
set -euo pipefail
cd sdk/dotnet
dotnet build
'''
sources = ["sdk/dotnet"]
outputs = ["sdk/dotnet/bin"]

[tasks."install:dotnet"]
description = "Install .NET SDK locally"
depends = ["build:dotnet"]
run = '''
set -euo pipefail
mkdir -p nuget
find sdk/dotnet/bin -name '*.nupkg' -print -exec cp -p "{}" "$(pwd)/nuget" \;
if ! dotnet nuget list source | grep -q "$(pwd)/nuget"; then
  dotnet nuget add source "$(pwd)/nuget" --name "$(pwd)/nuget"
fi
'''

[tasks."generate:go"]
description = "Generate Go SDK"
depends = ["install:plugins", "tfgen:build"]
run = '''
set -euo pipefail
mkdir -p sdk/go
export PULUMI_HOME="${PULUMI_HOME:-$(pwd)/.pulumi}"
export PULUMI_CONVERT_EXAMPLES_CACHE_DIR="${PULUMI_HOME}/examples-cache"
export PULUMI_CONVERT="${PULUMI_CONVERT}"
export PULUMI_DISABLE_AUTOMATIC_PLUGIN_ACQUISITION="${PULUMI_CONVERT}"
bin/${CODEGEN} go --out sdk/go/
'''
sources = ["provider/cmd/pulumi-resource-docker/schema.json"]
outputs = ["sdk/go"]

[tasks."build:go"]
description = "Build Go SDK packages"
depends = ["generate:go"]
run = '''
set -euo pipefail
cd sdk
module_path="$(grep -e "^module" go.mod | cut -d ' ' -f 2)"
go list "${module_path}/go/..." | xargs -I {} bash -c 'go build {} && go clean -i {}'
'''
sources = ["sdk/go", "sdk/go.mod"]
outputs = ["sdk/go"]

[tasks."generate:java"]
description = "Generate Java SDK"
depends = ["install:plugins", "tfgen:build"]
run = '''
set -euo pipefail
mkdir -p sdk/java
export PULUMI_HOME="${PULUMI_HOME:-$(pwd)/.pulumi}"
export PULUMI_CONVERT_EXAMPLES_CACHE_DIR="${PULUMI_HOME}/examples-cache"
export PULUMI_CONVERT="${PULUMI_CONVERT}"
export PULUMI_DISABLE_AUTOMATIC_PLUGIN_ACQUISITION="${PULUMI_CONVERT}"
bin/${CODEGEN} java --out sdk/java/
printf "module fake_java_module // Exclude this directory from Go tools\n\ngo 1.17\n" > sdk/java/go.mod
'''
sources = ["provider/cmd/pulumi-resource-docker/schema.json"]
outputs = ["sdk/java"]

[tasks."build:java"]
description = "Build Java SDK"
depends = ["generate:java"]
run = '''
set -euo pipefail
cd sdk/java
gradle --console=plain build
gradle --console=plain javadoc
'''
sources = ["sdk/java"]
outputs = ["sdk/java/build"]

[tasks."generate:nodejs"]
description = "Generate Node.js SDK"
depends = ["install:plugins", "tfgen:build"]
run = '''
set -euo pipefail
mkdir -p sdk/nodejs
export PULUMI_HOME="${PULUMI_HOME:-$(pwd)/.pulumi}"
export PULUMI_CONVERT_EXAMPLES_CACHE_DIR="${PULUMI_HOME}/examples-cache"
export PULUMI_CONVERT="${PULUMI_CONVERT}"
export PULUMI_DISABLE_AUTOMATIC_PLUGIN_ACQUISITION="${PULUMI_CONVERT}"
bin/${CODEGEN} nodejs --out sdk/nodejs/
printf "module fake_nodejs_module // Exclude this directory from Go tools\n\ngo 1.17\n" > sdk/nodejs/go.mod
'''
sources = ["provider/cmd/pulumi-resource-docker/schema.json"]
outputs = ["sdk/nodejs"]

[tasks."build:nodejs"]
description = "Build Node.js SDK"
depends = ["generate:nodejs"]
run = '''
set -euo pipefail
cd sdk/nodejs
yarn install
yarn run tsc
cp ../../README.md ../../LICENSE package.json yarn.lock ./bin/
'''
sources = ["sdk/nodejs", "README.md", "LICENSE", "package.json", "sdk/nodejs/yarn.lock"]
outputs = ["sdk/nodejs/bin"]

[tasks."install:nodejs"]
description = "Link Node.js SDK locally"
depends = ["build:nodejs"]
run = '''
set -euo pipefail
yarn link --cwd sdk/nodejs/bin
'''

[tasks."install:go"]
description = "Placeholder for Go SDK installation"
run = "true"

[tasks."install:java"]
description = "Placeholder for Java SDK installation"
run = "true"

[tasks."generate:python"]
description = "Generate Python SDK"
depends = ["install:plugins", "tfgen:build"]
run = '''
set -euo pipefail
mkdir -p sdk/python
export PULUMI_HOME="${PULUMI_HOME:-$(pwd)/.pulumi}"
export PULUMI_CONVERT_EXAMPLES_CACHE_DIR="${PULUMI_HOME}/examples-cache"
export PULUMI_CONVERT="${PULUMI_CONVERT}"
export PULUMI_DISABLE_AUTOMATIC_PLUGIN_ACQUISITION="${PULUMI_CONVERT}"
bin/${CODEGEN} python --out sdk/python/
printf "module fake_python_module // Exclude this directory from Go tools\n\ngo 1.17\n" > sdk/python/go.mod
cp README.md sdk/python/
'''
sources = ["provider/cmd/pulumi-resource-docker/schema.json", "README.md"]
outputs = ["sdk/python"]

[tasks."build:python"]
description = "Build Python SDK"
depends = ["generate:python"]
run = '''
set -euo pipefail
cd sdk/python
rm -rf ./bin ../python.bin
cp -R . ../python.bin
mv ../python.bin ./bin
rm ./bin/go.mod
python3 -m venv venv
./venv/bin/python -m pip install build==1.2.1
cd ./bin
../venv/bin/python -m build .
'''
sources = ["sdk/python", "README.md"]
outputs = ["sdk/python/bin"]

[tasks."install:python"]
description = "Placeholder for Python SDK installation"
run = "true"

[tasks."build:registry-docs"]
description = "Generate registry docs"
depends = ["install:plugins", "tfgen:build"]
run = '''
set -euo pipefail
mkdir -p docs
bin/${CODEGEN} registry-docs --out "$(pwd)/docs"
'''
sources = ["provider/cmd/pulumi-resource-docker/schema.json"]
outputs = ["docs"]

[tasks."generate:sdks"]
description = "Generate all SDKs"
run = [
  { tasks = ["generate:nodejs", "generate:python", "generate:dotnet", "generate:go", "generate:java"] }
]

[tasks."build:sdks"]
description = "Build all SDKs"
run = [
  { tasks = ["build:nodejs", "build:python", "build:dotnet", "build:go", "build:java"] }
]

[tasks."install:sdks"]
description = "Install all SDKs locally"
run = [
  { tasks = ["install:nodejs", "install:python", "install:dotnet", "install:go", "install:java"] }
]

[tasks.generate]
description = "Generate schema, docs, and all SDKs"
depends = ["generate:sdks", "schema", "build:registry-docs"]
run = "true"

[tasks.build]
description = "Build provider and SDKs, install artifacts"
depends = ["setup", "install:plugins", "provider", "build:sdks", "install:sdks", "build:registry-docs"]
run = "true"

[tasks."prepare:workspace"]
description = "Install plugins and prepare upstream workspace"
depends = ["install:plugins", "upstream"]
run = "true"

[tasks."lint:provider"]
description = "Run golangci-lint on provider"
depends = ["upstream"]
run = '''
set -euo pipefail
cd provider
golangci-lint run --path-prefix provider -c ../.golangci.yml
'''

[tasks."lint:provider:fix"]
description = "Run golangci-lint with --fix on provider"
depends = ["upstream"]
run = '''
set -euo pipefail
cd provider
golangci-lint run --path-prefix provider -c ../.golangci.yml --fix
'''

[tasks.test]
description = "Run example integration tests"
depends = ["build"]
run = '''
set -euo pipefail
export PATH="$(pwd)/bin:${PATH}"
cd examples
go test -v -tags=all -parallel ${TESTPARALLELISM} -timeout 2h ${GOTESTARGS}
'''

[tasks."test:provider"]
description = "Run provider unit tests"
depends = ["build"]
run = '''
set -euo pipefail
cd provider
go test -v -short -coverprofile="coverage.txt" -coverpkg="./...,github.com/hashicorp/terraform-provider-..." -parallel ${TESTPARALLELISM} ./...
'''

[tasks.clean]
description = "Clean build artifacts"
run = '''
set -euo pipefail
rm -rf sdk/{dotnet,nodejs,go,python}
rm -rf bin/*
rm -rf .make/*
rm -rf .pulumi/examples-cache
if dotnet nuget list source | grep -q "$(pwd)/nuget"; then
  dotnet nuget remove source "$(pwd)/nuget"
fi
'''

[tasks.docs]
description = "Run docs generator helper"
depends = ["docs:examples"]
run = "true"

[tasks."ci:mgmt"]
description = "Regenerate CI config"
run = '''
set -euo pipefail
go run github.com/pulumi/ci-mgmt/provider-ci@master generate
'''

[tasks."debug:tfgen"]
description = "Start dlv against tfgen"
depends = ["tfgen:build"]
run = '''
set -euo pipefail
dlv --listen=:2345 --headless=true --api-version=2 exec bin/${CODEGEN} -- schema --out provider/cmd/${PROVIDER}
'''
